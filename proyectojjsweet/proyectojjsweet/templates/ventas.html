{% extends "base.html" %}

{% block title %}Ventas - Facturaci√≥n{% endblock %}
{% block body_class %}ventas-body{% endblock %}

{% block content %}
<h1> üõí Sistema de Ventas</h1>

<form action="{{ url_for('factura') }}" method="POST" id="formVentas">
  <h3>Datos del Cliente</h3>
  <input type="text" id="cliente" name="cliente" placeholder="Nombre del Cliente" required>
  <input type="text" id="documento" name="documento" placeholder="CC/NIT" required>
  <input type="text" id="telefono" name="telefono" placeholder="Tel√©fono del Cliente">
  <input type="email" id="correo" name="correo" placeholder="Correo del Cliente" required>
  <input type="text" id="direccion" name="direccion" placeholder="Direcci√≥n del Cliente">
  <input type="date" id="fecha" name="fecha" value="{{ fecha_hoy }}" required>

  <h3>Agregar Productos</h3>

  <!-- Buscador con dropdown -->
  <div style="position: relative; max-width: 400px;">
    <input type="text" id="buscarProducto" placeholder="üîç Buscar producto..." autocomplete="off">
    <div id="resultadosProductos" class="dropdown"></div>
  </div>

  <input type="number" id="cantidad" placeholder="Cantidad" min="1" style="width:120px; margin-top:8px;">
  <button type="button" id="agregarBtn">‚ûï Agregar</button>

  <!-- Tabla de productos -->
  <table border="1" id="tablaProductos" style="margin-top:12px;">
    <thead>
      <tr>
        <th>Producto</th>
        <th>Precio</th>
        <th>Cantidad</th>
        <th>Total</th>
        <th>Quitar</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <input type="hidden" name="productos_json" id="productos_json">

  <button type="submit" style="margin-top:12px;">üßæ Generar Factura</button>
</form>

<script>
(function(){
  // Productos desde Flask
  const productos = JSON.parse('{{ productos|tojson|safe }}').map(p => ({
    id: String(p[0]),
    nombre: String(p[1]),
    precio: Number(p[2])
  }));

  const buscarInput = document.getElementById("buscarProducto");
  const resultadosDiv = document.getElementById("resultadosProductos");
  const cantidadInput = document.getElementById("cantidad");
  const agregarBtn = document.getElementById("agregarBtn");
  const tablaBody = document.querySelector("#tablaProductos tbody");
  const productosJSON = document.getElementById("productos_json");

  let productoSeleccionado = null;
  let productosSeleccionados = [];

  // üîé Filtrar productos al escribir
  buscarInput.addEventListener("input", function(){
    const q = this.value.trim().toLowerCase();
    resultadosDiv.innerHTML = "";

    if (q.length === 0) {
      resultadosDiv.style.display = "none";
      return;
    }

    const coincidencias = productos.filter(p => p.nombre.toLowerCase().includes(q));

    if (coincidencias.length > 0) {
      resultadosDiv.style.display = "block";
      coincidencias.forEach(p => {
        const div = document.createElement("div");
        div.className = "resultado-item";
        div.textContent = `${p.nombre} - $${p.precio.toFixed(2)}`;
        div.dataset.id = p.id;
        div.dataset.nombre = p.nombre;
        div.dataset.precio = p.precio;
        resultadosDiv.appendChild(div);
      });
    } else {
      resultadosDiv.style.display = "none";
    }
  });

  // üìå Seleccionar producto desde el dropdown
  resultadosDiv.addEventListener("click", function(e){
    if (e.target.classList.contains("resultado-item")) {
      productoSeleccionado = {
        id: e.target.dataset.id,
        nombre: e.target.dataset.nombre,
        precio: parseFloat(e.target.dataset.precio)
      };
      buscarInput.value = productoSeleccionado.nombre;
      resultadosDiv.style.display = "none";
      cantidadInput.focus();
    }
  });

  // ‚ûï Agregar producto a la tabla
  agregarBtn.addEventListener("click", function(){
    if (!productoSeleccionado) return alert("Seleccione un producto v√°lido");
    const cantidad = parseInt(cantidadInput.value);
    if (!cantidad || cantidad < 1) return alert("Ingrese cantidad v√°lida");

    const total = productoSeleccionado.precio * cantidad;

    productosSeleccionados.push({
      id: productoSeleccionado.id,
      nombre: productoSeleccionado.nombre,
      precio: productoSeleccionado.precio,
      cantidad,
      total
    });

    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td>${productoSeleccionado.nombre}</td>
      <td>$${productoSeleccionado.precio.toFixed(2)}</td>
      <td>${cantidad}</td>
      <td>$${total.toFixed(2)}</td>
      <td><button type="button" class="eliminarBtn">‚ùå</button></td>
    `;
    tablaBody.appendChild(fila);

    productosJSON.value = JSON.stringify(productosSeleccionados);

    // Reset
    buscarInput.value = "";
    cantidadInput.value = "";
    productoSeleccionado = null;
  });

  // ‚ùå Eliminar producto
  tablaBody.addEventListener("click", function(e){
    if (e.target.classList.contains("eliminarBtn")) {
      const fila = e.target.closest("tr");
      const index = Array.from(tablaBody.children).indexOf(fila);
      productosSeleccionados.splice(index, 1);
      fila.remove();
      productosJSON.value = JSON.stringify(productosSeleccionados);
    }
  });

  // üßë Autocompletar cliente
  document.getElementById("documento").addEventListener("blur", async function(){
    const doc = this.value;
    if (!doc) return;
    const resp = await fetch(`/proyectojjsweet/buscar_cliente?documento=${encodeURIComponent(doc)}`);
    const data = await resp.json();
    if (data.existe) {
      document.getElementById("cliente").value = data.nombre || "";
      document.getElementById("telefono").value = data.telefono || "";
      document.getElementById("direccion").value = data.direccion || "";
      document.getElementById("correo").value = data.correo || "";
    }
  });
})();
</script>
{% endblock %}
